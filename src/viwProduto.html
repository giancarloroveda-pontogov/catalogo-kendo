<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="ISO-8859-1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <style>
    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100vh;
    }

    .content {
      width: 100%;
      max-width: 800px;
    }

    #produto-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
    }

    .input-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .full-width {
      width: 100% !important;
    }
  </style>

  <link href="img/icons/pg.favicon.png" rel="shortcut icon">

  <link href="css/pg.kendo.common.min.css" rel="stylesheet">
  <link href="css/pg.kendo.blueopal.min.css" rel="stylesheet">
  <link href="css/pg.kendo.blueopal.mobile.min.css" rel="stylesheet">
  <link href="css/pg.kendo.colors.min.css" rel="stylesheet">
  <link href="css/pg.icons.css" rel="stylesheet">
  <link href="css/pg.libFrontbox.css" rel="stylesheet">
  <link href="css/pg.multiple-select.css" rel="stylesheet">
  <link href="css/pg.loading.css" rel="stylesheet">
  <link href="css/kendo.global.min.css" rel="stylesheet">
  <link href="css/ckeditor.pontogov.css" rel="stylesheet">
  <link rel="stylesheet" href="js/prettyPhoto/css/prettyPhoto.css" type="text/css" media="screen" />
  <link href="js/rs-plugin/css/settings.css" rel="stylesheet">
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/redmond/jquery-ui.css">
  <link rel="stylesheet" href="global-styles.css">


  <script src="js/libJquery.js" charset="ISO-8859-1"></script>
  <script src="js/jszip.min.js" charset="ISO-8859-1"></script>
  <script src="js/kendo.all.min.js" charset="ISO-8859-1"></script>
  <script src="js/kendo.messages.pt-BR.min.js" charset="ISO-8859-1"></script>
  <script src="js/kendo.masked.date.picker.js" charset="ISO-8859-1"></script>
  <script src="js/kendo.culture.pt-BR.min.js" charset="ISO-8859-1"></script>
  <script src="js/pako_deflate.min.js" charset="ISO-8859-1"></script>
  <script src="js/libPgFilter.js" charset="ISO-8859-1"></script>

  <script src="js/fusion/fusioncharts.js"></script>
  <script src="js/fusion/themes/fusioncharts.theme.fint.js"></script>

  <script src="js/libUtils.js" charset="ISO-8859-1"></script>
  <script src="js/libFrontbox.js" charset="ISO-8859-1"></script>
  <script src="js/kendo.timezones.min.js" charset="ISO-8859-1"></script>
  <script src="js/ckeditor/ckeditor.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/multiple-select.js"></script>
  <script src="js/prettyPhoto/js/jquery.prettyPhoto.js" type="text/javascript"></script>
  <script src="js/rs-plugin/js/jquery.themepunch.tools.min.js"></script>
  <script src="js/rs-plugin/js/jquery.themepunch.revolution.min.js"></script>
  <script src="js/mascara.js" type="text/javascript"></script>
  <script src="js/jquery.mask.js" charset="ISO-8859-1"></script>
  <script src="./config/culture.js"></script>
</head>


<body>
  <div id="app">
    <main class="container">
      <div class="content">

        <form id="frmConsultaProduto">
          <div id="filters" class="k-block" style="margin-bottom: 8px;">
            <h2 class="k-header">Filtros</h2>
            <input type="text" name="filter_nome" id="filter_nome">
            <input type="text" name="filter_categoria" id="filter_categoria">
            <button type="button">Filtrar</button>
            <button type="reset">Limpar</button>

          </div>

          <div class="k-block">

            <div id="BarAcoes">
            </div>

            <section id="produtos-grid"></section>
          </div>
        </form>


        <div id="produto-form-dialog">
          <form id="produto-form">
            <input type="hidden" name="id" id="id">

            <input class="full-width" name="nome" id="nome">

            <div class="input-container">
              <label for="categoria">Categoria</label>
              <input class="full-width" name="categoria" id="categoria">
            </div>

            <input class="full-width" name="preco" id="preco">

            <div class="input-container">
              <label for="data_cadastro">Data de Cadastro</label>
              <input class="full-width" name="data_cadastro" id="data_cadastro">
            </div>

            <div class="input-container">
              <label for="ativo">Ativo</label>
              <input name="ativo" id="ativo">
            </div>

            <div id="form-actions"></div>
          </form>
        </div>


        <section id="produto-preview" style="margin-top: 8px;"></section>
      </div>
    </main>
  </div>
  <div id="application-global-alert"></div>

  <script type="module">
    import Observer from "./pubsub/Observer.js";
    import Produto from "./models/Produto.js";
    import ProdutoPreview from "./components/produto-preview/produto-preview.js";

    $(function () {
      console.log("teste")
      const produtoSelecionadoObserver = new Observer();

      // ToolBar
      $("#frmConsultaProduto #BarAcoes").kendoToolBar({
        resizable: false,
        items: [
          {
            type: "buttonGroup",
            buttons: [
              {
                type: "button",
                text: "Editar",
                enable: false,
                attributes: {
                  id: "editar-btn",
                },
                icon: "pencil",
                click: function () {
                  setFormData(getProdutoSelecionado());
                  $("#produto-form-dialog").data("kendoWindow").center().open();
                }
              },
              {
                type: "button",
                text: "Incluir",
                icon: "plus",
                click: function () {
                  setFormData();
                  $("#produto-form-dialog").data("kendoWindow").center().open();
                },
              },
            ]
          }
        ]
      })

      produtoSelecionadoObserver.subscribe((produto) => {
        const toolBar = $("#frmConsultaProduto #BarAcoes").data("kendoToolBar");
        toolBar.enable($("#editar-btn"), !!produto)
      })

      // Grid
      const dataSource = new kendo.data.DataSource({
        transport: {
          read: (options) => {
            options.success(Produto.getAll());
          },
        },
        schema: {
          model: {
            id: "id",
            fields: {
              id: { editable: false, nullable: true },
              nome: { type: "string", validation: { required: true } },
              categoria: { type: "string" },
              preco: { type: "number" },
              data_cadastro: { type: "date" },
              ativo: { type: "boolean" }
            }
          },
        },
        pageSize: 5,
      });

      $("#produtos-grid").kendoGrid({
        columns: [
          { field: "nome", title: "Nome" },
          { field: "categoria", title: "Categoria" },
          { field: "preco", title: "Preço", format: "{0:c}" },
          { field: "data_cadastro", title: "Data de Cadastro", format: "{0:dd/MM/yyyy}" },
          { field: "ativo", title: "Ativo", template: "#= ativo ? 'Sim' : 'Não' #" },
        ],
        dataSource,
        selectable: true,
        sortable: true,
        pageable: true,
        toolbar: ["excel", "search"],
        change: () => {
          produtoSelecionadoObserver.next(getProdutoSelecionado())
        }
      });

      // FormWindow
      $("#produto-form-dialog").kendoWindow({
        visible: false,
        modal: true,
        draggable: false,
        width: 400,
        title: "Incluir Produto",
        open: () => {
          const formActionsToolBar = $("#form-actions").data("kendoToolBar");
          formActionsToolBar.enable($("#excluir-btn"), $("#produto-form #id").val());
        }
      });

      $("#produto-form #nome").kendoTextBox({
        label: "Nome",
      });

      $("#produto-form #categoria").kendoDropDownList({
        dataSource: [
          { name: "Roupas" },
          { name: "Calçados" },
          { name: "Acessórios" },
          { name: "Eletrodomésticos" },
          { name: "Móveis" },
          { name: "Ferramentas" },
        ],
        dataTextField: "name",
        dataValueField: "name",
        filter: "contains",
        autoBind: false,
      })

      $("#produto-form #preco").kendoNumericTextBox({
        format: "c2",
        spinners: false,
        decimals: 2,
        label: "Preço",
      })

      $("#produto-form #data_cadastro").kendoDatePicker({
        format: "dd/MM/yyyy",
      });
      $("#produto-form #data_cadastro").kendoMaskedTextBox({
        mask: "00/00/0000",
      })

      $("#produto-form #ativo").kendoSwitch();

      const handleGravar = () => {
        const produto = getFormData();
        const dataSource = $("#produtos-grid").data("kendoGrid").dataSource;

        try {
          const produtoInstancia = new Produto(produto);

          produtoInstancia.persist();

          $("#produto-form-dialog").data("kendoWindow").close();
          setFormData();
          dataSource.read();
        } catch (e) {
          UIService.showError(e);
        }
      };

      const handleExcluir = () => {
        const produto = getFormData();
        const dataSource = $("#produtos-grid").data("kendoGrid").dataSource;
        try {
          const result = Produto.delete(Number(produto.id));
          $("#produto-form-dialog").data("kendoWindow").close();
          setFormData();
          dataSource.read();
        } catch (e) {
          UIService.showError(e);
        }
      };

      $("#form-actions").kendoToolBar({
        items: [
          { type: "button", text: "Gravar", icon: "save", click: handleGravar },
          {
            type: "button",
            text: "Excluir",
            icon: "trash",
            enable: false,
            id: "excluir-btn",
            click: handleExcluir
          },
          {
            type: "button",
            text: "Fechar",
            icon: "x",
            click: () => $("#produto-form-dialog").data("kendoWindow").close()
          },
        ],
        rounded: true
      })

      // Filters
      $("#filters #filter_nome").kendoTextBox({
        placeholder: "Nome",
      });

      $("#filters #filter_categoria").kendoDropDownList({
        dataSource: [
          { name: "Roupas" },
          { name: "Calçados" },
          { name: "Acessórios" },
          { name: "Eletrodomésticos" },
          { name: "Móveis" },
          { name: "Ferramentas" },
        ],
        dataTextField: "name",
        dataValueField: "name",
        filter: "contains",
        autoBind: false,

      });

      $("#filters button[type='button']").kendoButton({
        click: () => {
          const filters = {
            nome: $("#filters #filter_nome").data("kendoTextBox").value(),
            categoria: $("#filters #filter_categoria").data("kendoDropDownList").value(),
          }

          const dataSource = $("#produtos-grid").data("kendoGrid").dataSource;
          dataSource.filter({
            logic: "and",
            filters: [
              {
                field: "nome",
                operator: "contains",
                value: filters.nome
              },
              {
                field: "categoria",
                operator: "contains",
                value: filters.categoria
              }
            ]
          });
        }
      })

      $("#filters button[type='reset']").kendoButton({
        click: () => {
          $("#filters #filter_nome").data("kendoTextBox").value("")
          $("#filters #filter_categoria").data("kendoDropDownList").value("")
          $("#filters #filter_categoria").data("kendoDropDownList").select(-1)

          const dataSource = $("#produtos-grid").data("kendoGrid").dataSource;
          dataSource.filter({});
        }
      })

      function getFormData() {
        const id = $("#produto-form #id").val();
        const nome = $("#produto-form #nome").data("kendoTextBox").value();
        const categoria = $("#produto-form #categoria").data("kendoDropDownList").value();
        const preco = $("#produto-form #preco").data("kendoNumericTextBox").value();
        const data_cadastro = $("#produto-form #data_cadastro").data("kendoDatePicker").value();
        const ativo = $("#produto-form #ativo").data("kendoSwitch").check();

        return {
          id,
          nome,
          categoria,
          preco,
          data_cadastro,
          ativo
        }
      }

      function setFormData(produto) {
        $("#produto-form #id").val(produto?.id || null);
        $("#produto-form #nome").data("kendoTextBox").value(produto?.nome || "");
        $("#produto-form #categoria").data("kendoDropDownList").value(produto?.categoria || "");
        !produto && $("#produto-form #categoria").data("kendoDropDownList").select(-1);
        $("#produto-form #preco").data("kendoNumericTextBox").value(produto?.preco || "");
        $("#produto-form #data_cadastro").data("kendoDatePicker").value(produto?.data_cadastro || "");
        $("#produto-form #ativo").data("kendoSwitch").check(produto?.ativo || false);
      }

      function getProdutoSelecionado() {
        const grid = $("#produtos-grid").data("kendoGrid");
        const selectedRows = grid.select();
        if (!selectedRows.length) {
          return null;
        }
        return new Produto(grid.dataItem(selectedRows[0]));
      }

      new ProdutoPreview().render({
        parentElement: $("#produto-preview"),
        observer: produtoSelecionadoObserver
      })
    });
  </script>
</body>

</html>